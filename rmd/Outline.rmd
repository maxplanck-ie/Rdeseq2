---
title: "Outline"
author: "Thomas Manke"
date: "`r date() `"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

This outline contains a (minimal) skeleton of a typical DESeq2 workflow - as discussed during the course.  For specific projects, the parts on data exploration, quality controls and filtering are frequently more iterative and require custom-made adoption.


# Installation 
```{r installation, eval=FALSE}
BiocManager::install("DESeq2")
install.packages("tidyverse")
install.packages("pheatmap")
```

# Load Tools
```{r load}
#.libPaths("/new/location/")     # set if libs are not in default location
library(DESeq2)
library(pheatmap)
library(tidyverse)
```


# Load Data, Metadata and Design
```{r import}
# read data
dfile <- "../data/counts_qc.tsv"                          # location of data file
data <- read.csv(file=dfile, header=TRUE, sep="\t")
data <- data %>% column_to_rownames("geneID")             # geneID -> rownames

# read metadata
mfile <- "../data/counts_qc_meta.tsv"                     # location of metadata file
metadata <- read.csv(file=mfile, header=TRUE, sep="\t")
metadata <- metadata %>% column_to_rownames("sample")     # sample -> rownames
metadata$condition = as.factor(metadata$condition)
metadata$celltype  = as.factor(metadata$celltype)

# define design
my_design <- ~ condition 
```

# Create DESeq2 object
```{r dds}
dds <- DESeqDataSetFromMatrix(countData=data, colData=metadata, design= my_design)

# Data Exploration
rld <- rlog(dds)  
plotPCA(rld, intgroup=c("condition", "celltype"), returnData=TRUE)

# ....
```



# Typical Filtering
```{r filtering}
# remove genes
keep_genes <- rowSums(counts(dds)) > 1
dds <- dds[keep_genes,]

# remove or swap samples as required
keep_samples= grep("^BM",colnames(dds))  # just for illustration
dds <- dds[,keep_samples]

# rerun after filtering
rld <- rlog(dds)  
plotPCA(rld, intgroup=c("condition", "celltype"), returnData=TRUE)
```

# Run DESeq
```{r DEseq2}
dds <- DESeq(dds)                           # size factors, dispersion, fit model, run WaldTest

# QC
colData(dds)                                # inspect sizefactors
plotDispEsts(dds, main="Dispersion plot")   # plot dispersion
```

# DE-Testing
```{r testing}
contrast <- c("condition", "DMSO", "AMIL")                   # define contrast
res <- results(dds, contrast = contrast,  alpha = 0.05)      # results table

res <- lfcShrink(dds, contrast = contrast, type = "normal")  # pref. type="apeglm" needs add. package
sorted_res <- res %>% data.frame() %>% arrange(padj)             # sort by adjusted p-value
```

# Filter Results
```{r filter}
padj.cutoff <- 0.05
summary(res, alpha=padj.cutoff)	
sig_res <- sorted_res %>% rownames_to_column(var="gene") %>% filter(padj < padj.cutoff)
```

# Visualization
```{r visualization}
# MA plot
plotMA(res, ylim=c(-3,3))

# Volcano Plot
sorted_res %>% 
  mutate(significant=padj<padj.cutoff) %>% 
  mutate(rank=row_number()) %>% 
  add_rownames("gene_name") %>% 
  ggplot(aes(x=log2FoldChange, y=-log10(padj), color=significant)) + 
  geom_point() + 
  geom_text(aes(label=ifelse(rank<5,gene_name,'')), size = 3, hjust=0,vjust=-0.15)
  
# heatmap
ntop=20
top_genes = sorted_res %>% head(ntop) %>% row.names()
top_rld   = assay(rld[top_genes,], normalized=TRUE) 
pheatmap(top_rld, main="Top DE Genes")
```

# Output
```{r}
fn <- paste( c(contrast, "results.csv"), collapse='_') # generate meaningful filename
write.csv(sorted_res,  file=fn, quote=FALSE)
```

# SessionInfo
```{r sessionInfo}
sessionInfo()
```


