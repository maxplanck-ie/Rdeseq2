---
title: "DESeq2 Outline"
author: "MPI-IE Bioinfo-Core"
#date: "`r date() `"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

This outline contains a template of a typical DESeq2 workflow - as discussed during the course.  For specific projects, the parts on data exploration, quality controls and filtering are frequently more iterative and require custom-made adoption.


# Installation 
```{r installation, eval=FALSE}
BiocManager::install("DESeq2")
install.packages("tidyverse")
install.packages("pheatmap")
install.packages("ashr")
```

# Load Tools
```{r load, message=FALSE}
#.libPaths("/data/manke/processing/RdeseqEnv/R-4.0.3_Rcourse/lib64/R/library") 
library(DESeq2)
library(pheatmap)
library(tidyverse)
library(ashr)
```


# Data, Metadata and Design
```{r import}
dfile <- "/data/manke/processing/RdeseqData/mpp/mpp_counts.tsv"     
data <- read_tsv(dfile)
#data <- data %>% column_to_rownames("gene_id") 
data <- data %>% 
  filter( !str_detect(gene_id,"^[1|2]-Mar") ) %>%
  column_to_rownames("gene_id") 

mfile <- "/data/manke/processing/RdeseqData/mpp/mpp_meta.tsv"      
metadata <- read_tsv(mfile)
metadata$condition <- as.factor(metadata$condition)
metadata$celltype  <- as.factor(metadata$celltype)
metadata <- metadata %>% column_to_rownames("sample") 

my_design <- ~ celltype + condition + celltype:condition

all(rownames(metadata) == colnames(data))  # sanity check

dds <- DESeqDataSetFromMatrix(countData=data, colData=metadata, design= my_design)
```
# Data Exploration and Filters
```{r filtering}
# data exploration and QC: not shown

# remove genes
keep_genes <- rowSums(counts(dds)) > 1
dds <- dds[keep_genes,]

# process samples as required
# ...

# rerun Data Exploration and QC
# ...
```

# Run DESeq
```{r DEseq2}
dds <- DESeq(dds)                          
# mcols(dds)       # for the curious: check results of modeling (for each gene)

# Normalization for Visualization
rld <- rlog(dds)  # alternatively: vst(dds)

# Scale rows (for heatmap) = transpose; (column) scale; transpose
A = assay(rld, normalized=TRUE) %>% t %>% scale %>% t 

#Inspection
#colData(dds)                                # sizefactors
#plotDispEsts(dds, main="Dispersion plot")   # dispersion
plotPCA(rld, intgroup=c("condition", "celltype"))
```

# Differential Genes

## Define Contrasts
Verify (base) levels and available coefficient (resultsNames).   
Define model matrix.

```{r levels}
levels(colData(dds)$condition)
levels(colData(dds)$celltype)
resultsNames(dds)
mod_mat <- model.matrix(my_design, metadata)
```

## Extract Results
```{r testing}
fn="YvA_MPP2.tsv"    # filename for output

# define contrast systematically
Aged_MPP2 <-  which(dds$condition=="Aged"  & dds$celltype=="MPP2")
Young_MPP2 <- which(dds$condition=="Young" & dds$celltype=="MPP2")
YvA_MPP2=colMeans(mod_mat[Young_MPP2,]) - colMeans(mod_mat[Aged_MPP2,]) 
# YvA_MPP2 = c(0,0,0,1,0,1)  # same free-hand: switch on condition=Young and interaction=MPP2:Young

res <- lfcShrink(dds, contrast=YvA_MPP2, type = "ashr")                       # alternative results(dds, ...)

res %>% head(5)                                        # first few results
summary(res)	                                         # summary for all genes
plotMA(res, ylim=c(-3,3))                              # MA-plot from DESeq2
plot(res$log2FoldChange, -log10(res$padj), cex=0.3)    # very simple volcano

plotCounts(dds, gene=which.min(res$padj), intgroup=c("condition","celltype"))  # plot top-gene

# prepare heatmap for top genes
ntop <- 15
sorted_res <- res %>% data.frame() %>% arrange(padj)   # sort results by padj
top_genes <- sorted_res %>% head(ntop) %>% row.names() # top gene names
col_sel=c(Young_MPP2,Aged_MPP2)                        # select only samples in contrast
pheatmap(A[top_genes,col_sel], main="Top DE Genes (rlog)", annotation=metadata)

# write sorted results to file (add rowname as column)
write_tsv(sorted_res %>% rownames_to_column("Gene"), file=fn, quote=FALSE)            
```

# SessionInfo
```{r sessionInfo}
sessionInfo()
```



```{r my_volcano}
# low-key alternative to
# EnhancedVolcano(res, lab = rownames(res), x = 'log2FoldChange', y = 'pvalue')

# the above needs lots of dependencies

my_volcano = function(sorted_res){
  sorted_res %>% 
  mutate(significant=padj<padj.cutoff) %>% 
  mutate(rank=row_number()) %>% 
  add_rownames("gene_name") %>% 
  ggplot(aes(x=log2FoldChange, y=-log10(padj), color=significant)) + 
  geom_point() + 
  geom_text(aes(label=ifelse(rank<5,gene_name,'')), size = 3,
            hjust=0,vjust=-0.15) 
}
```

