---
title: "deseq2 - applied"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---
# Goals:
# Apply what was learned through the course.
  # Initial QC and visualisation.
  # Run the DESeq workflow
  # Interpret some of the results.

Dataset: MPPs

Background:

We are looking in murine bone marrow cells. More specifically, the stem- and multipotent progenitor cells.
A (very expensive) experiment was set up, and there is RNA-seq data available three cellTypes:
 
 - HSCs
 - MPP1
 - MPP2

collected from both young and aged mice.
You and your lab are eager to see:

 - Did the experiment work ?
 - What are the effects of aging on the different cell populations ?

# Hands-on
Load some libraries.

```{r add libraries, message=FALSE, warning=FALSE, paged.print=FALSE}
.libPaths("/data/processing3/RdeseqCourse/RdeseqEnv/R-4.0.3_Rcourse/lib64/R/library")
library("DESeq2")
library("dplyr")
library("tibble")
library("ggplot2")
library("pheatmap")
library("UpSetR")
library("tidyr")
```

Read in the data.
```{r read in data, message=FALSE, warning=FALSE, paged.print=FALSE}
# Get the data directory
data_dir <- "/data/processing3/RdeseqCourse/Data/mpp/"

# Read count matrix
countdata <- read.table(paste0(data_dir, "mpp_counts.tsv", sep=''),
                        header=TRUE, row.names = 1)
#head(countdata)

# Read samplesheet , detects conditions, generate the formula
sampleInfo <- read.table(paste0(data_dir, "mpp_meta.tsv", sep=''),
                          header=TRUE, check.names = TRUE, stringsAsFactor = F)
sampleInfo$celltype <- as.factor(sampleInfo$celltype)
sampleInfo$condition <- as.factor(sampleInfo$condition)
rownames(sampleInfo) <- sampleInfo$sample
sampleInfo$sample <- NULL
print(sampleInfo)
```

Check our factors !
```{r factorLevels, message=FALSE, warning=FALSE, paged.print=FALSE}
print(sampleInfo$celltype)
print(sampleInfo$condition)
```
Relevel factors !
```{r relevel condition factor, message=FALSE, warning=FALSE, paged.print=FALSE}
levels(sampleInfo$condition) <- c("Young","Aged")
print(sampleInfo$condition)
```

# Build DESeq object.

```{r build DESeq, message=FALSE, warning=FALSE, paged.print=FALSE}
dds <- DESeqDataSetFromMatrix(countData=countdata,
                              colData=sampleInfo,
                              design = ~celltype*condition
                              )
```

# plotPCA
```{r PCA, message=FALSE, warning=FALSE, paged.print=FALSE}
plotPCA(rlog(dds, blind=TRUE),
        intgroup=c("celltype", "condition")
        )
```

# run DESeq2

```{r Run deseq, message=FALSE, warning=FALSE, paged.print=FALSE}
dds <- DESeq(dds)
```

# plot dispersion

```{r Dispersion, message=FALSE, warning=FALSE, paged.print=FALSE}
plotDispEsts(dds)
```

# LRT for age.

```{r lrt-condition, message=FALSE, warning=FALSE}
# which model are we interested in as reduced?
dds_lrt <- DESeq(dds, test="LRT", reduced = ~celltype)
res_lrt <- results(dds_lrt)
```

# results.
```{r parseResults, message=FALSE, warning=FALSE}
cleanDF <- function(RESobj){
  RESdf <- data.frame(RESobj) %>%
    dplyr::filter(baseMean > 0) %>%
    drop_na() %>%
    arrange(padj)
  return(RESdf)
}

res_lrt_clean <- cleanDF(res_lrt)
head(res_lrt_clean)
```

# Look at the 25 genes with lowest p-value.
```{r heatmap_lrt, message=FALSE, warning=FALSE}

pheatmap(
  counts(dds, normalized=TRUE)[head( rownames(res_lrt_clean) , n=25),],
  scale = 'row',
  main='Age effect - LRT',
  labels_row = head(rownames(res_lrt_clean), n=25 )
)
```
